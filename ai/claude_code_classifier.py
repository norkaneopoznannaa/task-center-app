"""
Классификатор задач через Claude Code

Этот модуль позволяет использовать Claude Code (а не API) для классификации задач.
Работает с Pro подпиской на claude.ai через Claude Code CLI.
"""

from typing import List
from core.models import Task, TaskType, Complexity, Priority


def prepare_tasks_for_classification(tasks: List[Task]) -> str:
    """
    Подготовка задач для классификации через Claude Code

    Возвращает текст с задачами для анализа
    """
    prompt = """Проанализируй следующие задачи проекта РЭМД и классифицируй каждую.

КОНТЕКСТ ПРОЕКТА РЭМД:
- Российская электронная медицинская документация
- Ключевые системы: ФЛК (формально-логический контроль), СЭМД (структурированные электронные медицинские документы), ГИСЗ (государственная информационная система здравоохранения), МИС (медицинские информационные системы)
- Высокая критичность - связано с медицинскими данными и персональными данными

ЗАДАЧИ ДЛЯ КЛАССИФИКАЦИИ:

"""

    for i, task in enumerate(tasks, 1):
        prompt += f"\n{'='*60}\n"
        prompt += f"ЗАДАЧА #{i}\n"
        prompt += f"ID: {task.id}\n"
        prompt += f"Название: {task.title}\n"
        prompt += f"Описание: {task.description}\n"

        if task.jira_references:
            jira_ids = ', '.join(ref.ticket_id for ref in task.jira_references)
            prompt += f"Jira: {jira_ids}\n"

        if task.mentions:
            mentions = ', '.join(p.name for p in task.mentions)
            prompt += f"Упоминания: {mentions}\n"

    prompt += f"\n{'='*60}\n\n"

    prompt += """
ДЛЯ КАЖДОЙ ЗАДАЧИ ОПРЕДЕЛИ:

1. **Тип задачи**:
   - Анализ/Исследование (изучение требований, исследование проблем, анализ паттернов)
   - Документация (создание/обновление документов, регламентов, инструкций)
   - Разработка (написание кода, доработка функционала, технические задачи)
   - Координация (организация встреч, согласования, подготовка демо)
   - Баг/Проблема (исправление ошибок, проверка изменений)

2. **Сложность**:
   - низкая (простые задачи, до 2 часов)
   - средняя (требует анализа, 2-8 часов)
   - высокая (комплексные задачи, более 8 часов)

3. **Приоритет** (1-5):
   - 5 (CRITICAL) - блокирующие баги, срочные задачи, влияние на продакшен
   - 4 (HIGH) - важные задачи с дедлайном на неделе, задачи от руководства
   - 3 (MEDIUM) - обычные задачи, плановые работы
   - 2 (LOW) - улучшения, некритичные задачи
   - 1 (BACKLOG) - идеи для будущего

4. **Оценка времени** (в часах)

5. **Ключевые термины** (ФЛК, СЭМД, ГИСЗ, МИС, СНИЛС, etc)

6. **Связанные системы** (какие компоненты РЭМД затронуты)

7. **Краткое объяснение** выбора классификации

ВАЖНЫЕ ФАКТОРЫ:
- Слова "срочно", "критично", "блокер", "asap" → повышают приоритет
- Связь с ФЛК, СЭМД, ГИСЗ → повышает приоритет
- Баги в продакшене → CRITICAL
- Проверки и валидация данных → высокая важность
- Персональные данные (СНИЛС) → повышенное внимание

ВЕРНИ РЕЗУЛЬТАТ В ФОРМАТЕ JSON ДЛЯ КАЖДОЙ ЗАДАЧИ:

```json
[
  {
    "task_id": "id задачи",
    "task_type": "один из типов",
    "complexity": "низкая/средняя/высокая",
    "priority": 1-5,
    "estimated_hours": число или null,
    "key_terms": ["список терминов"],
    "related_systems": ["список систем"],
    "reasoning": "объяснение (1-2 предложения)",
    "confidence": 0.0-1.0
  },
  ...
]
```

ВАЖНО: Верни ТОЛЬКО JSON массив, без дополнительного текста.
"""

    return prompt


def get_classification_instruction() -> str:
    """Инструкция для пользователя по использованию классификации через Claude Code"""

    return """
╔══════════════════════════════════════════════════════════════╗
║  Классификация задач через Claude Code                      ║
╚══════════════════════════════════════════════════════════════╝

Для классификации задач с помощью Claude Code:

1. Запустите команду:

   python task_manager.py classify-interactive

2. Откроется сессия Claude Code с вашими задачами

3. Claude проанализирует задачи и предложит классификацию

4. Подтвердите результаты для сохранения

ПРЕИМУЩЕСТВА:
✓ Работает с вашей Pro подпиской claude.ai
✓ Не требует отдельного API ключа
✓ Полный контроль над процессом
✓ Можно корректировать результаты

ПРИМЕЧАНИЕ:
- Эта команда открывает интерактивную сессию
- Claude Code должен быть установлен и настроен
- Работает через вашу текущую подписку
"""
